---
title: "TVIMS_DZ5_Smyslovskikh"
author: "Елена Смысловских"
date: "8/04/2020"
output: html_document
---

## Задание 1

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message = FALSE}
library(readstata13)
library(fs)
library(haven)
library(psych)
library(dplyr)
library(ggplot2)
library(GGally)
library(car)
library(memisc)
library(knitr)
opts_chunk$set(fig.align = 'center')
```
```{r, message=FALSE}
df <- read.dta13("https://politologi-tvims2.github.io/hw15.dta")
df <- dplyr::select(df, c(ch_schools_pc, afreq, nozemstvo, distance_moscow, goodsoil, lnurban, lnpopn, province_capital))
head(df)
```

Уже из шапки данных мы видим, что в них есть пропуски. Избавимся от них.

```{r}
df <- na.omit(df)
```

Теперь построим регрессионную модель и оценим ее.
```{r}
mod1 <- lm(ch_schools_pc ~ afreq + nozemstvo + distance_moscow + goodsoil + lnurban + lnpopn + province_capital, data = df)
summary(mod1)
```
Из выдачи видно, что: есть два значимых предиктора - это _afreq_ (доля лет между 1851 и 1863 гг. с крестьянскими выступлениями) и  _nozemstvo_ (0 - если в результате Земской реформы создали земство, 1 - если не создали) на уровне значимости 0.001, а также константа (0.001), lnurban(0.1), lnpopn(0.05).

__Интерпретация:__

- При увеличении доли лет с 1851 до 1863 года, в течение которых были зафиксированы крестьянские выступления, на 1 единицу измерения, _ch_schools_pc_ (количество школ на душу сельского населения уезда) в среднем и при прочих равных снизится на величину, равную 0.181470.
- При условии того, что в результате реформы 1864 года земство создано не было, количество школ на душу сельского населения уезда в среднем и при прочих равных увеличится на 0.080091.
- При условии того, что все предикторы равны 0, количество школ на душу сельского населения уезда принимает значение 0.683238.

__Теоретические основания предполгать наличие гетероскедастичности:__

- Во-первых, вполне возможно, в модель ошибочно заложена линейная взаимосвязь, в то время как на самом деле она может быть нелинейной (например, количество школ на душу сельского населения уезда может расти, если восстаний было немного (что говорит о гражданском потенциале), и убывать, если их было слишком много и регион сильно пострадал в результате этого вместе со всей инфраструктурой)
- Во-вторых, мы можем иметь скошенное распределение по какой-либо из переменных, и в данном случае логично предполагать скошенность распределения переменной _afreq_ , поскольку потенциал уезда к крестьянским выступлениям скорее всего будет зависеть от истории выступлений в прошлом, а также от общей тенденции населения к коллективному действию. Таким образом, можно предположить, что доля лет, в которые происходили крестьянские выступления, будет распределена неравномерно, и в отдельных регионах будет завышена по сравнению с остальными.

Проверим на графике:

```{r fig.height=3, fig.width=3}
hist(df$afreq)
```

Действительно, мы видим, что в основной массе уездов крестьянские выступления происходили не более, чем в половине лет за изучаемый период, при этом есть более редкие случаи, в которых доля лет, в которые происходили крестьянские вытспуления, составляет от 0.5 до 0.8.

- Мы можем иметь дело с влиятельными наблюдениями, что скорее всего произойдет, поскольку отдельные регионы (и все уезды в них) могут быть важными урбанизированными территориями или иметь повышенное финансирование, соответственно, в них будет строиться больше школ.

- Данные взяты из разных источников, что может исказить распределение ошибок для каких-то определенных показателей, а это может привести к гетероскедастичности в модели.

- Наконец, мы могли пропустить какой-то значимый показатель и наоборот, включить неверный: например, у меня есть сомнения по поводу того, насколько предиктор _goodsoil_ (показатель плодородности почвы) влияет на изменение в количестве школ на душу сельского населения уезда. Возможно, он был взят в качестве прокси на экономическое благосостояние уезда, однако учитывая, что промышленный переворот в России начался в 30-40-е годы XIX века и завершился в 1880-х, то скорее всего, эта переменная не годится для модели. 

## Задание 2
```{r, message = FALSE}
library(sandwich)
```

1. Посмотрим на __визуализацию__.

Рассмотрим распределение показателей:

```{r fig.height=3, fig.width=3}
ggplot(mod1, aes(afreq, mod1$residuals^2)) + geom_point()
```
На некоторых участках распределения мы можем наблюдать выбросы,т.е. в некоторых уездах было зафиксировано аномально большое количество школ на душу населения.
```{r fig.height=3, fig.width=3}
ggplot(mod1, aes(nozemstvo, mod1$residuals^2)) + geom_point()
```
В случае, если земство создано не было, мы наблюдаем менее однородное распределение, однако в обоих случаях есть выбросы среди наблюдений.
```{r fig.height=3, fig.width=3}
ggplot(mod1, aes(distance_moscow, mod1$residuals^2)) + geom_point()
```
Есть выбросы.
```{r fig.height=3, fig.width=3}
ggplot(mod1, aes(goodsoil, mod1$residuals^2)) + geom_point()
```
Переменая _goodsoil_ имеет скошенное распределение: очень мало наблюдений со средними значениями, а также есть выбросы.
```{r fig.height=3, fig.width=3}
ggplot(mod1, aes(lnurban, mod1$residuals^2)) + geom_point()
```
Мы видим, что в случае переменной _lnurban_ мы имеем дело с нетипичными значениями, которые сильно отклоняются от среднего, то есть, _leverage_.

```{r fig.height=3, fig.width=3}
ggplot(mod1, aes(lnpopn, mod1$residuals^2)) + geom_point()
```
Переменная _lnpopn_ имеет несколько выбросов.

```{r fig.height=3, fig.width=3}
ggplot(mod1, aes(province_capital, mod1$residuals^2)) + geom_point()
```

Теперь посмотрим на распределение квадратов остатков по всем предикторам:
```{r fig.height=3, fig.width=3}
ggplot(mod1, aes(afreq, mod1$residuals^2)) + geom_point()
ggplot(mod1, aes(nozemstvo, mod1$residuals^2)) + geom_point()
ggplot(mod1, aes(distance_moscow, mod1$residuals^2)) + geom_point()
ggplot(mod1, aes(goodsoil, mod1$residuals^2)) + geom_point()
ggplot(mod1, aes(lnurban, mod1$residuals^2)) + geom_point()
ggplot(mod1, aes(lnpopn, mod1$residuals^2)) + geom_point()
ggplot(mod1, aes(province_capital, mod1$residuals^2)) + geom_point()

```

Наконец, посмотрим на линейную свертку модели (предсказанные значения):
```{r}
ggplot(mod1, aes(mod1$fitted.values, ch_schools_pc)) + geom_point()
```
Из проделанной визуализации можно сделать вывод, что многие факторы дают нам основания предполагать наличие гетероскедастичности в модели в связи с неравномерностью распределения.

2. Теперь проведем формальный _тест Бреуша-Пагана__ для того, чтобы точно определить, страдает ли модель от гетероскедастичности.
```{r, message = FALSE}
library(lmtest)
```

```{r}
bptest(mod1)
```
Тестируем нулевую гипотезу об отсутствии гетероскедастичности в модели. Мы видим, что значение _p-value_ очень маленькое (<0.01, что меньше конвенционального уровня значимости), соответственно, у нас есть основания отвергнуть нулевую гипотезу, мы можем заявлять о возможном наличии гетероскедастичности.

3. Проведем тест __Goldfeld-Quandt__ для каждого предиктора чтобы оценить, зависит ли разброс ошибок от конкретной переменной.
В данном случае нулевая гипотеза снова будет об отсутствии гетероскедастичности.Для каждого теста проранжируем наблюдения по предиктору, затем оценим, насколько модель, из которой исклюены 20% наблюдений в середине выборки, будет отличаться от исходной модели.

```{r}
# afreq
gqtest(mod1, order.by = ~afreq, data = df, fraction = 0.2)
```
_p-value_ = 1, следовательно, у нас нет оснований отвергнуть нулевую гипотезу. То есть, данный тест не подтвердил наше предположение о том, что гетероскедастичность в модели присутствует из-за смещенного распределения доли лет, в которых случались крестьянские восстания.

```{r}
# nozemstvo
gqtest(mod1, order.by = ~nozemstvo, data = df, fraction = 0.2)
```

```{r}
# distance_moscow
gqtest(mod1, order.by = ~distance_moscow, data = df, fraction = 0.2)
```
По резульатам тестов, у нас есть основания отвергнуть нулевую гипотезу для предикторов _nozemstvo_ и _distance_moscow_, так как _p-value_ имеет низкое значение для всех разумных уровней значимости.

```{r}
# goodsoil
gqtest(mod1, order.by = ~goodsoil, data = df, fraction = 0.2)

# lnurban
gqtest(mod1, order.by = ~lnurban, data = df, fraction = 0.2)

# lnpopn
gqtest(mod1, order.by = ~lnpopn, data = df, fraction = 0.2)

# province_capital
gqtest(mod1, order.by = ~province_capital, data = df, fraction = 0.2)
```
Для всех остальных переменных, с учетом того, что _p-value_ близко к 1, у нас нет оснований отвергнуть нулевую гипотезу.

Исходя из результатов тестов, мы можем утверждать, что заявлять о гетероскедастичности мы можем только исходя из двух предикторов, а именно: отсутствия введенного земства и расстояния уезда до Москвы.

4. Поскольку на предыдущем шаге мы выявили гетероскедастичность по двум переменным, то попробуем переоценить стандартные ошибки.

```{r}
coeftest(mod1, vcov = vcovHC(mod1, "HC3"))
```
Действительно, можно сказать, что результаты изменились. Предикторы _afreq_ и _nozemstvo_ потеряли в значимости, константа - тоже, а _lnpopn_ и вовсе перестал быть значимым в модели. При этом коэффициенты остались стабильными.

## Задание 3

Теперь протестируем модель на влиятельные наблюдения. 

1. Посмотрим на __взаимосвязь hat-values и Стьюдентизированных остатков__. Для этого построим графики:
```{r}
influencePlot(mod1)
```

```{r, message=FALSE}
library(olsrr)
```

```{r}
ols_plot_cooksd_bar(mod1)
```

Исходя из полученных графиков, можно сделать некоторые выводы о наличии влиятельных наблюдений в модели. Мы видим, что 3 наблюдения выходят за границы [-2; 2] по оси Стьюдентизированных остатков, а также имеют большой радус окружности, которая соотносится с величиной _Cook`s distance_. Это говорит нам о том, что наблюдения под этими индексами влиятельные и могут значимо изменить коэффициенты в модели. Еще два наблюдения не выходят за границы по Стьюдентизированным остаткам или мере Кука, однако они имеют высокие _hat-values_, что свидетельствует о наличии _leverage_. Таким образом, мы можем говорить, что эти два наблюдения сильно отличаются от среднего по X, тем самым, скорее всего они меняют не только константу при добавлении в модель без этих наблюдений. 

Нетипичные наблюдения могут значительно ухудшить  результаты моделирования - они могут сделать оценки смещенными или неэффективными.

2. Попробуем переоценить модель без трех наиболее значимых наблюдений.

```{r}
dfnew <- df[-c(43, 163, 160), ]
mod2 <- lm(data = dfnew, ch_schools_pc ~ afreq + nozemstvo + distance_moscow + goodsoil + lnurban + lnpopn + province_capital)
summary(mod2)
```
Итак, мы видим, что значимость двух предикторов, которые были наиболее значимыми в исходной модели, снизилась. Но при этом увеличилась значимость константы. это говорит нам о том, что мы скорее всего не учли в модели какие-то предикторы, которые содержательно важны. 


